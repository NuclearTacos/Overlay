<!DOCTYPE html>
<html>
<!-- CSS only -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css"
  rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor"
  crossorigin="anonymous">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


  
<style>
.overlay-container {  
  align-items: center;
  justify-content: center;
  margin: auto;
  width: fit-content;
}
  
#container {
  width: 400px;
  height: 400px;
  position: relative;

  /*background: blue;*/
}

#animate {
  width: 50px;
  height: 50px;
  position: relative;
  background-color: red;
}
</style>
<body>

<div>
  <div class="bucket">
  </div>
</div>


<script>
// Helper Methods
function createGuid() {
   return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
   });
}

function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// end Helper Methods

// classes
class OverlayElement {
  get id(){
    return this._id;
  }

  get cardTemplate(){
    return this._cardTemplate;
  }

  showCeremony(){
    const showCode = "{ let id = '"+this._id+"';"+this._showCeremony+" }";
    setTimeout(showCode, 1);
  }

  hideCeremony(){
    const hideCode = "{ let id = '"+this._id+"';"+this._removeCeremony+" }";
    setTimeout(hideCode, 1);
  }

  updateTemplateId(){
    this._cardTemplate = $(this._cardTemplate).attr('id',this._id).prop('outerHTML');
  }

  constructor(jsonConfig) {
    this._id = createGuid();
    this._config = JSON.parse(jsonConfig);
    
    this._cardTemplate = this._config.cardTemplate;
    this._showCeremony = this._config.showCeremony;
    this._removeCeremony = this._config.removeCeremony;

    this.updateTemplateId();

    $('.bucket').append(this._cardTemplate);
  }
}
// endclasses

async function elementLifeCycle(){
  let data = '{ "exCount": 0 }';
  let cardData = $.ajax({
    type: "POST",
    async: false,
    dataType: "application/json",
    url: "https://read-environment-var-kwrdwjisqa-uc.a.run.app",
    data: data
  }).responseText;

  {
    await delay(1000);
    let newElement = new OverlayElement(cardData);
    newElement.showCeremony();
    await delay(3000);
    newElement.hideCeremony();
  }
}

function getElementsData(gameName){
  let demoData = "{\r\n    \"games\":[\r\n        {\r\n            \"name\": \"dnd5e\",\r\n            \"data\": {\r\n                \"spells\": [\r\n                    {\r\n                        \"name\": \"Fire Bolt\",\r\n                        \"level\": 0,\r\n                        \"damage_type\": \"fire\",\r\n                        \"description\": \"<p>You hurl a mote of fire at a creature or object within range. Make a ranged spell attack against the target. On a hit, the target takes 1d10 fire damage. A flammable object hit by this spell ignites if it isn\'t being worn or carried.<\/p><p>This spell\'s damage increases by 1d10 when you reach 5th level (2d10), 11th level (3d10), and 17th level (4d10).<\/p>\",\r\n                        \"bucket\": \"tf-overlays-db\",\r\n                        \"object\": \"basic-card.json\"\r\n                    }\r\n                ],\r\n                \"characters\": [\r\n\r\n                ],\r\n                \"rules\": [\r\n\r\n                ],\r\n                \"art\": [\r\n\r\n                ]\r\n            }\r\n        }\r\n    ]\r\n}"
  let responseObj = JSON.parse(demoData);
  
  return responseObj.games.filter( game => game.name == gameName )[0].data;
}

function getElementTemplate(element){
  var cardUrl = JSON.parse( $.ajax({
    type: "GET",
    async: false,
    dataType: "application/json",
    url: 'https://storage.googleapis.com/storage/v1/b/'+element.bucket+'/o/'+element.object
  }).responseText).mediaLink;

  let elemTemplate = $.ajax({
      type: "GET",
      async: false,
      dataType: "application/json",
      url: cardUrl
    }).responseText;

  return elemTemplate;
}

function mergeSpellElement(spell,element){
  $('#'+element.id+' .ph-level').html(spell.damage_type);
  $('#'+element.id+' .ph-name').html(spell.name);
  $('#'+element.id+' .ph-description').html(spell.description);
}

$(document).ready( function() {
  let elementsData = getElementsData("dnd5e");
  let firebolt = elementsData.spells.filter( spell => spell.name == 'Fire Bolt')[0];
  
  let elementTemplate = getElementTemplate(firebolt);

  delay(1000).then( function(){
    let newElement = new OverlayElement(elementTemplate);
    mergeSpellElement(firebolt, newElement);

    newElement.showCeremony();
    delay(3000).then( function() {
      newElement.hideCeremony();
    });
  });
});

</script>

</body>
<!--
It might be better if you use a Markdown to HTML converter.
I recommend ShowdownJS. Just add it to your project with
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.0/showdown.min.js"></script>
-->
</html>
