<!DOCTYPE html>
<html>
<!-- CSS only -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css"
  rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor"
  crossorigin="anonymous">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


  
<style>
.overlay-container {  
  align-items: center;
  justify-content: center;
  margin: auto;
  width: fit-content;
}
  
#container {
  width: 400px;
  height: 400px;
  position: relative;

  /*background: blue;*/
}

#animate {
  width: 50px;
  height: 50px;
  position: relative;
  background-color: red;
}
</style>
<body>

<div>
  <div class="bucket">
  </div>
</div>


<script>
// Helper Methods
function createGuid() {
   return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
   });
}

function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function bucketRequest(bucketName, fileRoute){
  let blobUrl = JSON.parse( $.ajax({
    type: "GET",
    async: false,
    dataType: "application/json",
    url: 'https://storage.googleapis.com/storage/v1/b/'+bucketName+'/o/'+fileRoute
  }).responseText).mediaLink;

  let blobData = $.ajax({
      type: "GET",
      async: false,
      dataType: "application/json",
      url: blobUrl
    }).responseText;
  
  return blobData;
}
// end Helper Methods

// classes
class OverlayElement {
  get id(){
    return this._id;
  }

  get cardTemplate(){
    return this._cardTemplate;
  }

  showCeremony(){
    const showCode = "{ let id = '"+this._id+"';"+this._showCeremony+" }";
    setTimeout(showCode, 1);
  }

  hideCeremony(){
    const hideCode = "{ let id = '"+this._id+"';"+this._removeCeremony+" }";
    setTimeout(hideCode, 1);
  }

  updateTemplateId(){
    this._cardTemplate = $(this._cardTemplate).attr('id',this._id).prop('outerHTML');
  }

  constructor(jsonConfig) {
    this._id = createGuid();
    this._config = JSON.parse(jsonConfig);
    
    this._cardTemplate = this._config.cardTemplate;
    this._showCeremony = this._config.showCeremony;
    this._removeCeremony = this._config.removeCeremony;

    this.updateTemplateId();

    $('.bucket').append(this._cardTemplate);
  }
}
// endclasses

// cloudcommands
function uploadDatabase(dataObj){
  return $.ajax({
    type: "POST",
    async: false,
    dataType: "application/json",
    url: "https://upload-data-kwrdwjisqa-uc.a.run.app",
    data: JSON.stringify(dataObj)
  });
}

function readDatabase(){
  return bucketRequest('tf-overlays-db','data.json');
}

function postOverlaysCommand(command){
  let commandObject = {
    "id": createGuid(),
    "command": command
  }

  let cardData = $.ajax({
    type: "POST",
    async: false,
    dataType: "application/json",
    url: "https://write-command-kwrdwjisqa-uc.a.run.app",
    data: JSON.stringify(commandObject)
  }).responseText;
}


// todo: make this check against the Id of the last processed command.
function readOverlaysCommand(){
  return JSON.parse( bucketRequest('tf-overlays-db','active-command.json') ).command;
}

async function elementLifeCycle(){
  let data = '{ "exCount": 0 }';
  let cardData = $.ajax({
    type: "POST",
    async: false,
    dataType: "application/json",
    url: "https://read-environment-var-kwrdwjisqa-uc.a.run.app",
    data: data
  }).responseText;

  {
    await delay(1000);
    let newElement = new OverlayElement(cardData);
    newElement.showCeremony();
    await delay(3000);
    newElement.hideCeremony();
  }
}
// endcloudcommands

function getElementsData(gameName){
  let demoData = bucketRequest('tf-overlays-db','data.json');
  let responseObj = JSON.parse(demoData);
  
  return responseObj.games.filter( game => game.key == gameName )[0].data;
}

// command structure:
// game.dnd5e/spells.fire_bolt
function processCommand(command){
  let data = JSON.parse(readDatabase());
  let propArray = command.split('/');

  let currentObj = data;
  propArray.forEach(element => {
    let commandPropertyKey = element.split('.')[0];
    let commandPropertyValue = element.split('.')[1];
    
    currentObj = currentObj[commandPropertyKey].filter( comm => comm.key == commandPropertyValue )[0];
  });
  
  if( ''+currentObj.cardTemplate != '' ){
    return currentObj;
  }
}

function getElementTemplate(element){
  // var cardUrl = JSON.parse( $.ajax({
  //   type: "GET",
  //   async: false,
  //   dataType: "application/json",
  //   url: 'https://storage.googleapis.com/storage/v1/b/'+element.bucket+'/o/'+element.object
  // }).responseText).mediaLink;

  // let elemTemplate = $.ajax({
  //     type: "GET",
  //     async: false,
  //     dataType: "application/json",
  //     url: cardUrl
  //   }).responseText;
  
  elemTemplate = bucketRequest(element.bucket, element.object);

  return elemTemplate;
}

function mergeSpellElement(spell,element){
  $('#'+element.id+' .ph-level').html(spell.damage_type);
  $('#'+element.id+' .ph-name').html(spell.name);
  $('#'+element.id+' .ph-description').html(spell.description);
}

let activeCommand = ''

$(document).ready( function() {
  // let elementsData = getElementsData("dnd5e");
  // let firebolt = elementsData.spells.filter( spell => spell.name == 'Fire Bolt')[0];
  postOverlaysCommand('games.dnd5e/spells.fire_bolt');
  let firebolt = processCommand(readOverlaysCommand());
  
  let elementTemplate = getElementTemplate(firebolt);

  delay(1000).then( function(){
    let newElement = new OverlayElement(elementTemplate);
    mergeSpellElement(firebolt, newElement);

    newElement.showCeremony();
    delay(4000).then( function() {
      newElement.hideCeremony();
    }).then( function(){

      // then try the next spell
      // let magicMissile = elementsData.spells.filter( spell => spell.name == 'Magic Missile')[0];
      postOverlaysCommand('games.dnd5e/spells.magic_missile');
      let magicMissile = processCommand(readOverlaysCommand());
  
      let elementTemplate2 = getElementTemplate(magicMissile);

      delay(1000).then( function(){
        let newElement = new OverlayElement(elementTemplate2);
        mergeSpellElement(magicMissile, newElement);

        newElement.showCeremony();
        delay(4000).then( function() {
          newElement.hideCeremony();
        });
      });
    });
  });

  // read command on interval
  // setInterval(() => {
  //   console.log( readOverlaysCommand() );
  // }, 1000);
});

</script>

</body>
<!--
It might be better if you use a Markdown to HTML converter.
I recommend ShowdownJS. Just add it to your project with
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.0/showdown.min.js"></script>
-->
</html>
